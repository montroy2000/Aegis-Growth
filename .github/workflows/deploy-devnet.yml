name: Deploy to Devnet

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet-beta

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          profile: minimal
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install Solana CLI
        run: |
          wget https://github.com/solana-labs/solana/releases/download/v1.18.26/solana-release-x86_64-unknown-linux-gnu.tar.bz2
          tar jxf solana-release-x86_64-unknown-linux-gnu.tar.bz2
          echo "$(pwd)/solana-release/bin" >> $GITHUB_PATH
      
      - name: Verify Solana installation
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          solana --version
          solana-keygen --version
      
      - name: Install Anchor CLI
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          export PATH="$HOME/.cargo/bin:$PATH"
          avm install 0.32.0
          avm use 0.32.0
      
      - name: Verify Anchor installation
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          anchor --version
      
      - name: Setup deployer keypair
        env:
          DEPLOYER_KEYPAIR: ${{ secrets.DEPLOYER_KEYPAIR }}
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          echo "$DEPLOYER_KEYPAIR" > deployer-keypair.json
          solana config set --keypair deployer-keypair.json
          solana config set --url ${{ github.event.inputs.network }}
      
      - name: Check deployer balance
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          BALANCE=$(solana balance | awk '{print $1}')
          echo "Deployer balance: $BALANCE SOL"
          if (( $(echo "$BALANCE < 2" | bc -l) )); then
            echo "âš ï¸  Warning: Low balance. You need at least 2 SOL for deployment."
            echo "Deployer address: $(solana address)"
            exit 1
          fi
      
      - name: Build program
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cd aegis-vault
          anchor build
      
      - name: Get program ID
        id: program_id
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          PROGRAM_ID=$(solana address -k aegis-vault/target/deploy/aegis_vault-keypair.json)
          echo "program_id=$PROGRAM_ID" >> $GITHUB_OUTPUT
          echo "Program ID: $PROGRAM_ID"
      
      - name: Deploy program
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cd aegis-vault
          anchor deploy --provider.cluster ${{ github.event.inputs.network }}
      
      - name: Verify deployment
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          PROGRAM_ID="${{ steps.program_id.outputs.program_id }}"
          solana program show $PROGRAM_ID
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**Program ID:** ${{ steps.program_id.outputs.program_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update frontend \`.env.local\` with the Program ID" >> $GITHUB_STEP_SUMMARY
          echo "2. Initialize the vault using the frontend deployment UI" >> $GITHUB_STEP_SUMMARY
          echo "3. Test deposit/withdraw functionality" >> $GITHUB_STEP_SUMMARY
      
      - name: Cleanup keypair
        if: always()
        run: rm -f deployer-keypair.json
