name: Deploy to Devnet
# Updated: 2026-02-12

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet-beta

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.75.0
        with:
          toolchain: 1.75.0
          components: clippy
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install Solana CLI
        run: |
          wget https://github.com/solana-labs/solana/releases/download/v1.18.26/solana-release-x86_64-unknown-linux-gnu.tar.bz2
          tar jxf solana-release-x86_64-unknown-linux-gnu.tar.bz2
          echo "$(pwd)/solana-release/bin" >> $GITHUB_PATH
      
      - name: Verify Solana installation
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          solana --version
          solana-keygen --version
      
      - name: Install Anchor CLI
        run: |
          npm install -g @coral-xyz/anchor-cli@0.30.1
          export PATH="$(pwd)/solana-release/bin:$PATH"
          anchor --version
      
      - name: Setup deployer keypair
        env:
          DEPLOYER_KEYPAIR: ${{ secrets.DEPLOYER_KEYPAIR }}
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          
          # Create keypair file with absolute path
          KEYPAIR_PATH="$(pwd)/deployer-keypair.json"
          echo "$DEPLOYER_KEYPAIR" > "$KEYPAIR_PATH"
          chmod 600 "$KEYPAIR_PATH"
          
          # Configure solana CLI with absolute path
          solana config set --keypair "$KEYPAIR_PATH"
          solana config set --url ${{ github.event.inputs.network }}
          
          # Export for anchor to use
          echo "ANCHOR_WALLET=$KEYPAIR_PATH" >> $GITHUB_ENV
          
          # Verify configuration
          echo "Keypair path: $KEYPAIR_PATH"
          echo "Deployer address: $(solana address)"
          echo "Network: $(solana config get | grep 'RPC URL')"
      
      - name: Check deployer balance and airdrop if needed
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          
          # Target balance: 4 SOL (deployment + buffer rent)
          TARGET_BALANCE=4
          MAX_RETRIES=3
          
          for ((i=1; i<=MAX_RETRIES; i++)); do
            BALANCE=$(solana balance | awk '{print $1}' || echo "0")
            echo "Current balance: $BALANCE SOL"
            
            if (( $(echo "$BALANCE >= $TARGET_BALANCE" | bc -l) )); then
              echo "âœ… Balance is sufficient."
              break
            fi
            
            echo "Attempt $i/$MAX_RETRIES: Requesting airdrop..."
            solana airdrop 2 || echo "Airdrop rate limited, waiting..."
            sleep 5
          done
          
          FINAL_BALANCE=$(solana balance | awk '{print $1}' || echo "0")
          if (( $(echo "$FINAL_BALANCE < 1.5" | bc -l) )); then
             echo "âŒ Error: Balance ($FINAL_BALANCE SOL) is likely too low for deployment."
             echo "Please manually fund address: $(solana address)"
             echo "Use https://faucet.solana.com/"
             exit 1
          fi
      
      - name: Clean cached lockfile
        run: |
          # Remove any cached Cargo.lock to prevent version 4 format issues
          rm -f aegis-vault/Cargo.lock
          echo "Cleaned any cached Cargo.lock files"
      
      - name: Build program
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          cd aegis-vault
          anchor build
      
      - name: Get program ID
        id: program_id
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          PROGRAM_ID=$(solana address -k aegis-vault/target/deploy/aegis_vault-keypair.json)
          echo "program_id=$PROGRAM_ID" >> $GITHUB_OUTPUT
          echo "Program ID: $PROGRAM_ID"
      
      - name: Deploy program
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          cd aegis-vault
          
          echo "ðŸ“¦ Starting deployment to ${{ github.event.inputs.network }}..."
          echo "Program ID: $(solana address -k target/deploy/aegis_vault-keypair.json)"
          echo "Deployer: $(solana address)"
          echo "Balance: $(solana balance)"
          echo "Anchor Wallet: $ANCHOR_WALLET"
          
          # Deploy with explicit error handling
          set -e  # Exit on any error
          anchor deploy --provider.cluster ${{ github.event.inputs.network }}
          
          echo "âœ… Deployment completed"
          
          # Wait for transaction confirmation
          sleep 10
      
      - name: Verify deployment
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          PROGRAM_ID="${{ steps.program_id.outputs.program_id }}"
          solana program show $PROGRAM_ID
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**Program ID:** ${{ steps.program_id.outputs.program_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update frontend \`.env.local\` with the Program ID" >> $GITHUB_STEP_SUMMARY
          echo "2. Initialize the vault using the frontend deployment UI" >> $GITHUB_STEP_SUMMARY
          echo "3. Test deposit/withdraw functionality" >> $GITHUB_STEP_SUMMARY
      
      - name: Cleanup keypair
        if: always()
        run: rm -f deployer-keypair.json
