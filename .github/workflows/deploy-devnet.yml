name: Deploy to Devnet
# Updated: 2026-02-12

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to deploy to'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet-beta

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.75.0
        with:
          toolchain: 1.75.0
          components: clippy
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install Solana CLI
        run: |
          wget https://github.com/solana-labs/solana/releases/download/v1.18.26/solana-release-x86_64-unknown-linux-gnu.tar.bz2
          tar jxf solana-release-x86_64-unknown-linux-gnu.tar.bz2
          echo "$(pwd)/solana-release/bin" >> $GITHUB_PATH
      
      - name: Verify Solana installation
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          solana --version
          solana-keygen --version
      
      - name: Install Anchor CLI
        run: |
          npm install -g @coral-xyz/anchor-cli
          export PATH="$(pwd)/solana-release/bin:$PATH"
          anchor --version
      
      - name: Setup deployer keypair
        env:
          DEPLOYER_KEYPAIR: ${{ secrets.DEPLOYER_KEYPAIR }}
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          echo "$DEPLOYER_KEYPAIR" > deployer-keypair.json
          solana config set --keypair deployer-keypair.json
          solana config set --url ${{ github.event.inputs.network }}
      
      - name: Check deployer balance and airdrop if needed
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          
          # Try to get balance, default to 0 if account not found
          BALANCE=$(solana balance | awk '{print $1}' || echo "0")
          echo "Current balance: $BALANCE SOL"
          
          # Compare floating point numbers
          if (( $(echo "$BALANCE < 2" | bc -l) )); then
            echo "Balance is low ($BALANCE SOL). Attempting airdrop..."
            solana airdrop 2 || echo "Airdrop failed or rate limited"
            
            # Check balance again
            NEW_BALANCE=$(solana balance | awk '{print $1}')
            echo "New balance: $NEW_BALANCE SOL"
            
            if (( $(echo "$NEW_BALANCE < 1" | bc -l) )); then
              echo "âŒ Error: Insufficient balance for deployment. Please fund $(solana address) manually."
              exit 1
            fi
          else
             echo "âœ… Balance is sufficient."
          fi
      
      - name: Build program
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          cd aegis-vault
          anchor build
      
      - name: Get program ID
        id: program_id
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          PROGRAM_ID=$(solana address -k aegis-vault/target/deploy/aegis_vault-keypair.json)
          echo "program_id=$PROGRAM_ID" >> $GITHUB_OUTPUT
          echo "Program ID: $PROGRAM_ID"
      
      - name: Deploy program
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          cd aegis-vault
          anchor deploy --provider.cluster ${{ github.event.inputs.network }}
      
      - name: Verify deployment
        run: |
          export PATH="$(pwd)/solana-release/bin:$PATH"
          PROGRAM_ID="${{ steps.program_id.outputs.program_id }}"
          solana program show $PROGRAM_ID
      
      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Network:** ${{ github.event.inputs.network }}" >> $GITHUB_STEP_SUMMARY
          echo "**Program ID:** ${{ steps.program_id.outputs.program_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Update frontend \`.env.local\` with the Program ID" >> $GITHUB_STEP_SUMMARY
          echo "2. Initialize the vault using the frontend deployment UI" >> $GITHUB_STEP_SUMMARY
          echo "3. Test deposit/withdraw functionality" >> $GITHUB_STEP_SUMMARY
      
      - name: Cleanup keypair
        if: always()
        run: rm -f deployer-keypair.json
